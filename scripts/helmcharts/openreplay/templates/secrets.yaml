{{- $secretData := dict }}
{{- if not .Values.global.postgresql.existingSecret }}
  {{- $_ := set $secretData "postgresql-password" (.Values.global.postgresql.postgresqlPassword | b64enc) }}
{{- end }}
{{- if not .Values.global.clickhouse.existingSecret }}
  {{- $_ := set $secretData "clickhouse-password" (.Values.global.clickhouse.password | b64enc) }}
{{- end }}
{{- if not .Values.global.s3.existingSecret }}
  {{- $_ := set $secretData "access-key" (.Values.global.s3.accessKey | b64enc) }}
  {{- $_ := set $secretData "secret-key" (.Values.global.s3.secretKey | b64enc) }}
{{- end }}
{{- if not .Values.global.orAppSecrets.existingSecret }}
  {{- $_ := set $secretData "assist-key" (.Values.global.assistKey | b64enc) }}
  {{- $_ := set $secretData "assist-jwt-secret" (.Values.global.assistJWTSecret | b64enc) }}
  {{- $_ := set $secretData "jwt-secret" (.Values.global.jwtSecret | b64enc) }}
  {{- $_ := set $secretData "jwt-spot-secret" (.Values.global.jwtSpotSecret | b64enc) }}
  {{- $_ := set $secretData "token-secret" (.Values.global.tokenSecret | b64enc) }}
  {{- $_ := set $secretData "jwt-refresh-secret" (.Values.global.jwtRefreshSecret | b64enc) }}
  {{- $_ := set $secretData "jwt-spot-refresh-secret" (.Values.global.jwtSpotRefreshSecret | b64enc) }}
  {{- $_ := set $secretData "license-key" (.Values.global.enterpriseEditionLicense | b64enc) }}
  {{- if .Values.global.scimAccessSecretKey }}
  {{- $_ := set $secretData "scim-access-secret-key" (.Values.global.scimAccessSecretKey | b64enc) }}
  {{- end }}
  {{- if .Values.global.scimRefreshSecretKey }}
  {{- $_ := set $secretData "scim-refresh-secret-key" (.Values.global.scimRefreshSecretKey | b64enc) }}
  {{- end }}
{{- end }}
{{- if gt (len $secretData) 0 }}
apiVersion: v1
kind: Secret
metadata:
  annotations:
    "helm.sh/hook": pre-install, pre-upgrade
    "helm.sh/hook-weight": "-6" # Higher precidence, so the first the config map will get created.
  name: or-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openreplay.labels" . | nindent 4 }}
type: Opaque
data:
{{- /*

There are 2 kinds of secrets:
1. External application secrets like PG, S3, clickhouse etc
2. OpenReplay Application secrets

Type 1 can have clubed or dedicated secrets
Type 2 will be clubbed to a single secret, password keys are constant.
*/ -}}
{{- range $key, $value := $secretData }}
  {{ $key }}: "{{ $value }}"
{{- end }}
{{- end }}
