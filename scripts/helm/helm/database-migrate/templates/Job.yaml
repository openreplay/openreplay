---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-migration-script
data:
  pgmigration.sh: |-
    old_version={{ .Values.fromVersion }}
    [[ old_version == "" ]] && (echo "From version for migrtion not set. eg use --set fromVersion=v1.4.0"; exit 100)
    git clone https://github.com/openreplay/openreplay -b {{ .Chart.AppVersion }}
    cd openreplay/scripts/helm
    migration_versions=(`ls -l db/init_dbs/$db | grep -E ^d | awk -v number=${old_version} '$NF > number {print $NF}' | grep -v create`)

---
apiVersion: batch/v1
kind: Job
metadata:
  name: postgresql-migrate
  labels:
    app: postgresql
spec:
  template:
    metadata:
      name: postgresqlMigrate
    spec:
      containers:
      - name: postgres
        image: bitnami/postgresql:13.3.0-debian-10-r53
        command: 
        - /bin/bash
        - /opt/migration.sh
        volumeMounts:
        - name: migrationscript
          mountPath: /opt/migration.sh
          subPath: pgmigration.sh
      volumes:
      - name: migrationscript
        configMap:
          name: postgres-migration-script
      restartPolicy: OnFailure
